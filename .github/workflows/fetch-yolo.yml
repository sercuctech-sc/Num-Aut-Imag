name: Fetch YOLOv8n ONNX

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download model (robust, multi-source)
        shell: bash
        run: |
          set -euo pipefail
          rm -f yolov8n.onnx

          URLS=(
            "https://raw.githubusercontent.com/ultralytics/assets/v0.0.0/yolov8n.onnx"
            "https://raw.fastgit.org/ultralytics/assets/v0.0.0/yolov8n.onnx"
            "https://cdn.jsdelivr.net/gh/ultralytics/assets@v0.0.0/yolov8n.onnx"
          )

          ok=0
          for u in "${URLS[@]}"; do
            echo "Trying: $u"
            if curl -L --fail --retry 5 --retry-delay 2 \
              -H "Accept: application/octet-stream" \
              -o yolov8n.onnx "$u"; then
              SIZE=$(stat -c%s yolov8n.onnx || echo 0)
              echo "Downloaded size: $SIZE bytes"
              if [ "$SIZE" -gt 1000000 ]; then
                ok=1
                break
              fi
            fi
            rm -f yolov8n.onnx
          done

          if [ "$ok" -ne 1 ]; then
            echo "FAILED: Could not download a valid model (file too small)."
            exit 1
          fi

          ls -lh yolov8n.onnx

      - name: Commit model to repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add yolov8n.onnx
          git commit -m "Add proper yolov8n.onnx model (server-fetched)" || echo "Nothing to commit"
          git push
