<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Num-Aut-Imag — Test ONNX Runtime Web</title>

  <!-- GitHub Pages project: /Num-Aut-Imag/ -->
  <base href="/Num-Aut-Imag/">

  <style>
    body { font-family: Roboto, Arial, sans-serif; padding: 16px; }
    h1 { margin: 0 0 10px; }
    .box { padding:12px; border:1px solid #ddd; border-radius:12px; margin:12px 0; }
    pre { background:#f5f5f5; padding:12px; border-radius:12px; white-space:pre-wrap; overflow:auto; }
    button { padding:10px 12px; border-radius:12px; border:1px solid #ccc; background:#fff; font-size:16px; }
    .ok { color:#0a7a1f; font-weight:700; }
    .bad { color:#8b0000; font-weight:700; }
    code { background:#f3f3f3; padding:2px 6px; border-radius:6px; }
    small { color:#555; }
  </style>
</head>

<body>
  <h1>Num-Aut-Imag — Test ONNX Runtime Web</h1>

  <div class="box">
    Stato: <span id="state">Pronto ✅</span>
  </div>

  <div class="box">
    <button id="btn">▶ Avvia test (carica modello)</button>
    <div style="margin-top:10px;">
      Modello usato: <code id="modelPath">./yolov8n.onnx</code><br/>
      <small>(il file deve stare nella stessa cartella di questo index.html)</small>
    </div>
  </div>

  <pre id="log">Log pronto…\n</pre>

  <!-- ONNX Runtime Web -->
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>

  <script>
    const logEl = document.getElementById('log');
    const stateEl = document.getElementById('state');
    const modelPathEl = document.getElementById('modelPath');

    function log(...args) {
      console.log(...args);
      logEl.textContent += args.map(x => {
        if (x instanceof Error) return (x.stack || x.message || String(x));
        if (typeof x === 'object') return JSON.stringify(x, null, 2);
        return String(x);
      }).join(' ') + '\n';
    }

    // Anti "pagina bianca": mostra qualsiasi errore JS a schermo
    window.addEventListener('error', (e) => {
      stateEl.className = "bad";
      stateEl.textContent = "Errore JS ❌ (vedi log)";
      log("window.error:", e.message, (e.filename || "") + ":" + (e.lineno || "") + ":" + (e.colno || ""));
      if (e.error) log(e.error);
    });

    window.addEventListener('unhandledrejection', (e) => {
      stateEl.className = "bad";
      stateEl.textContent = "Promise reject ❌ (vedi log)";
      log("unhandledrejection:", e.reason);
    });

    async function runTest() {
      try {
        stateEl.className = "";
        stateEl.textContent = "Avvio…";

        if (!window.ort) throw new Error("onnxruntime-web non caricato (ort undefined).");

        // ✅ WASM path corretto: cartella dist/ (non un singolo .wasm)
        ort.env.wasm.wasmPaths = "https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/";

        // ✅ Android-safe: evita simd + multithreading (compatibilità massima)
        ort.env.wasm.simd = false;
        ort.env.wasm.numThreads = 1;

        log("ORT OK");
        log("wasmPaths:", ort.env.wasm.wasmPaths);
        log("Android-safe: simd=false, threads=1");

        // ✅ modello locale nella repo
        const modelUrl = "./yolov8n.onnx";
        modelPathEl.textContent = modelUrl;
        log("Carico modello:", modelUrl);

        // Verifica rapida che il file esista davvero
        const resp = await fetch(modelUrl, { cache: "no-store" });
        if (!resp.ok) {
          throw new Error(
            "Modello non trovato: " + modelUrl +
            " (HTTP " + resp.status + "). " +
            "Carica yolov8n.onnx nella repo, stessa cartella di index.html."
          );
        }
        log("Modello trovato ✅ (fetch OK)");

        // ✅ FIX FINALE: lascia scegliere a ORT il provider migliore su Android
        // (niente executionProviders esplicito)
        log("Creo sessione ORT…");
        const session = await ort.InferenceSession.create(modelUrl);

        log("✅ Sessione creata!");
        log("Inputs:", session.inputNames);
        log("Outputs:", session.outputNames);

        stateEl.className = "ok";
        stateEl.textContent = "OK ✅ Modello caricato (Android-safe)";
        alert("OK ✅ Modello caricato!");
      } catch (e) {
        stateEl.className = "bad";
        stateEl.textContent = "KO ❌ (vedi log)";
        log("❌ ERRORE:", e);
        alert("Errore: " + (e?.message || e));
      }
    }

    document.getElementById("btn").addEventListener("click", runTest);
  </script>

  <hr />

  <div class="box">
    <div class="bad"><strong>Note importanti:</strong></div>
    <ul>
      <li>Devi avere <code>index.html</code> e <code>yolov8n.onnx</code> nella <strong>stessa cartella</strong> della repo.</li>
      <li>Se vedi KO, guarda il log: ti dirà se è 404 (file mancante) o altro.</li>
    </ul>
  </div>
</body>
</html>
